<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Portus</title>

		<meta name="description" content="Authorization service and fronted for Docker registry (v2)">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Portus</h1>
					<h3>github.com/suse/portus</h3>
				</section>

				<section>
					<h1>Artem Chernikov</h1>
					<h2>DevOps Engineer @ SUSE</h2>
					<h4>https://github.com/kalabiyau</h4>
				</section>

				<section>
					<h4>SUSE HackWeek 2015</h4>
					<h3>Apr 12, 2015</h3>
					<h4>github.com/flavio</h4>
					<h4>github.com/eotchi</h4>
					<h4>github.com/cyntss</h4>
					<h4>github.com/kalabiyau</h4>
				</section>

				<section>
					<h4>Glorious Contributors</h4>
					<img src="images/history/contribs.png">
				</section>

				<section>
					<h3>Docker Registry API v2</h3>
					<h2>Auth Diagram</h2>
					<img src="images/history/auth_diagram.png" />
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>docker push suse/portus </h2>
						```
						HTTP/1.1 401 Unauthorized\
						WWW-Authenticate: Bearer\
						realm="https://portus.suse.de/v2/token/",\
						service="registry.suse.de",\
						scope="repository:suse/portus:push"
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>Get Auth request</h2>
						```
						GET /v2/token/?service=registry.suse.de&scope=repository:suse\
						/portus:push&account=kalabiyau HTTP/1.1
						Host: portus.suse.de
						```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h1>JWT JOSE, Eh?</h1>
						```json
						{
							"typ": "JWT",
							"alg": "ES256",
							"kid": "PYYO:TEWU:V7JH:26JV:AQTZ:LJC3:SXVJ:XGHA:34F2:2LAQ:ZRMK:Z7Q6"
						}
						```
					</script>
				</section>

				<section>
					<h4>PYYO:TEWU:V7JH:26JV:AQTZ:LJC3:SXVJ:XGHA:34F2:2LAQ:ZRMK:Z7Q6</h4>
					<img src="images/history/wut.jpeg" />
				</section>

				<section>
					<h3>DuckDuckGo does not work:</h3>
					<img src="images/history/Homer-Simpson-DOH.jpg" />
					<h3>neither Google</h3>
				</section>

				<section>
					<h2>...the ID of the key which was used to sign the token</h2>
				</section>

				<section data-markdown>
					<h2>github.com/docker/libtrust</h2>
					<pre><code data-trim>
						 type PublicKey interface {
						 // KeyID returns a distinct identifier which is unique to this Public Key.
						 // The format generated by this library is a base32 encoding of a 240 bit
						 // hash of the public key data divided into 12 groups like so:
						 // ABCD:EFGH:IJKL:MNOP:QRST:UVWX:YZ23:4567:ABCD:EFGH:IJKL:MNOP
						 KeyID() string
					</code></pre>
				</section>

				<section data-markdown>
					<h2>keyIDFromCryptoKey</h2>
					<pre><code data-trim>

					</code></pre>
					<pre><code data-trim>
						func keyIDFromCryptoKey(pubKey PublicKey) string {
							// Generate and return a 'libtrust' fingerprint of the public key.
							// For an RSA key this should be: SHA256(DER encoded ASN1)
							// Then truncated to 240 bits and encoded into 12 base32 groups like so:
							// ABCD:EFGH:IJKL:MNOP:QRST:UVWX:YZ23:4567:ABCD:EFGH:IJKL:MNOP
							derBytes, err := x509.MarshalPKIXPublicKey(pubKey.CryptoPublicKey())
							if err != nil {
								return ""
							}
							hasher := crypto.SHA256.New()
							hasher.Write(derBytes)
							return keyIDEncode(hasher.Sum(nil)[:30])
						}

					</code></pre>
				</section>

				<section>
					<h2>Better Call <strike>Saul</strike> Security</h2>
					<img src="images/history/CyberSecurity.jpeg" />
				</section>

				<section data-markdown>
					<script type="text/template">
						<h3>Base32</h3>
						<h4>Electrologica X1(1958 - 1965) from Netherlands</h4>
						<img src="images/history/196_-electrologica-x1.jpg" width="350px">
						- Uppercase
						- No 1, 8, 0 symbols - not to confuse with I, B, O
						- Better for humans
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<img src="images/history/all_the_things.jpg" width="250px">
						<h3>RFC? RFC!</h3>
						4.5.  "kid" (Key ID) Parameter
						...The structure of the "kid" value is
						unspecified.  When "kid" values are used within a JWK Set, different
						keys within the JWK Set SHOULD use distinct "kid" values...
						<h3>https://tools.ietf.org/html/draft-ietf-jose-json-web-key-41#section-4.5</h3>
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>Generate kid</h2>
						```ruby
						def jwt_kid(private_key)
							sha256 = Digest::SHA256.new
							sha256.update(private_key.public_key.to_der)
							payload = StringIO.new(sha256.digest).read(30)
							Base32.encode(payload).split('').each_slice(4).each_with_object([]) do |slice, mem|
								mem << slice.join
								mem
							end.join(':')
						end
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>JWT Token creation #1</h2>
						<h3>Create Javascript Object Signing and Encryption (JOSE) Header</h3>

						```json
						 {
						   "typ" : "JWT",
						   "alg" : "ES256",
						   "kid" : "PYYO:TEWU:V7JH:26JV:AQTZ:LJC3:SXVJ:XGHA:34F2:2LAQ:ZRMK:Z7Q6"
						 }
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>JWT Token creation #2</h2>
						<h3>Build Claim</h3>

						```json
						{
							"iss" : "portus.suse.de",
							"sub" : "kalabiyau",
							"aud" : "registry.suse.de",
							"exp" : 1415387315,
							"nbf" : 1415387015,
							"iat" : 1415387015,
							"jti" : "tYJCO1c6cnyy7kAn0c7rKPgbV1H1bFws",
							"access" : [
								{ "type" : "repository",
						          "name" : "suse/portus",
							      "actions":["push"]
							    }
							]
						}
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>JWT Token creation #3</h2>
						<h2>Create Payload</h2>
						```
							Base64.encode64(jose_header)
							Base64.encode64(claim)
							join with dot
						```
						```
						   eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6IlBZWU86VEVXVTpWN0pIOjI2SlY6QVFUWjp.MSkMzOlNYVk...
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>JWT Token creation #4</h2>
						<img src="images/history/formula.png" style = "background-color: white">
						<h4> Booooring! </h4>
						```json
						{
							"kty": "EC",
							"crv": "P-256",
							"kid": "PYYO:TEWU:V7JH:26JV:AQTZ:LJC3:SXVJ:XGHA:34F2:2LAQ:ZRMK:Z7Q6",
							"d": "R7OnbfMaD5J2jl7GeE8ESo7CnHSBm_1N2k9IXYFrKJA",
							"x": "m7zUpx3b-zmVE5cymSs64POG9QcyEpJaYCD82-549_Q",
							"y": "dU3biz8sZ_8GPB-odm8Wxz3lNDr1xcAQQPQaOcr1fmc"
						}
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>Finally!</h2>
						```json
						{
							"token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6IlBZWU86VEVXVTpWN0pIOjI2SlY6QVFUWjpMSkMzOlNYVko6WEdIQTozNEYyOjJMQVE6WlJNSzpaN1E2In0.eyJpc3MiOiJhdXRoLmRvY2tlci5jb20iLCJzdWIiOiJqbGhhd24iLCJhdWQiOiJyZWdpc3RyeS5kb2NrZXIuY29tIiwiZXhwIjoxNDE1Mzg3MzE1LCJuYmYiOjE0MTUzODcwMTUsImlhdCI6MTQxNTM4NzAxNSwianRpIjoidFlKQ08xYzZjbnl5N2tBbjBjN3JLUGdiVjFIMWJGd3MiLCJhY2Nlc3MiOlt7InR5cGUiOiJyZXBvc2l0b3J5IiwibmFtZSI6InNhbWFsYmEvbXktYXBwIiwiYWN0aW9ucyI6WyJwdXNoIl19XX0.QhflHPfbd6eVF4lM9bwYpFZIV0PfikbyXuLx959ykRTBpe3CYnzs6YBK8FToVb5R47920PVLrh8zuLzdCr9t3w"
						}
						```
					</script>
				</section>

				<section data-markdown="">
					<script type="text/template">
						<h2>Use the token in Docker client</h2>
						```ruby
						Authorization: Bearer <token goes here>
						```
					</script>
				</section>

				<section>
					<h1>Miquel Sabaté Solà</h1>
					<h2>Docker team @ SUSE</h2>
					<h4>https://github.com/mssola</h4>
				</section>

				<section>
					<h2>An overview</h2>

					<img src="portus.png" />
				</section>

				<section>
					<h2>Authorization</h2>

					<ul>
						<li>Users should be able to have a better control of the contents of
							their private registries:</li>
						<ul>
							<li>Organize repositories in namespaces, controlled by teams.</li>
							<li>Be able to establish policies.</li>
						</ul>
					</ul>

				</section>

				<section>
					<h2>Teams and namespaces</h2>

					<ul>
						<li>Organize users in teams.</li>
						<li>Each team member has a role.</li>
						<ul>
							<li>Viewer: can only pull.</li>
							<li>Contributor: can pull and push.</li>
							<li>Owner: can pull, push and manage the team members.</li>
						</ul>
						<li>Each team has a set of namespaces, which group repositories.</li>
						<li>A repository groups multiple tags.</li>
					</ul>
				</section>

				<section>
					<h2>Navigating</h2>

					<video data-autoplay src="navigation.webm"></video>
				</section>

				<section>
					<h2>Pushing and pulling</h2>

					<video data-autoplay src="tagging.webm"></video>
				</section>

				<section>
					<h2>Admin</h2>

					<ul>
						<li>List and manage users.</li>
						<li>List teams.</li>
						<li>List and manage users.</li>
					</ul>
				</section>

				<section>
					<h2>Search</h2>
					<video data-autoplay src="search.webm"></video>
				</section>

        <section>
          <h2>Clone it!</h2>
          <img src="gh.png" />
        </section>

        <section>
          <h2>Thank you!</h2>
        </section>
			</div>
		</div>
		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				width: 1200,
				slideNumber: 'c / t',
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
